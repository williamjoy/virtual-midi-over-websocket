<!DOCTYPE html>
<html>
<head>
<title>Virtual Piano</title>
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
<script type="text/javascript" src="src/jquery.simple.websocket.js"></script>
<script src="JZZ.js"></script>
<script src="jzz-input-kbd.js"></script>
<script src="jzz-synth-tiny.js"></script>
</head>
<body>
  <h1>Web Synthesia</h1>
  <div id=piano_out_up></div>
  <div id=piano_out_down></div>

  <script><!--
  JZZ.synth.Tiny.register('Web Audio');
  //var midi_in = JZZ().openMidiIn();                      // default MIDI-In (if available)
  var midi_out = JZZ().openMidiOut();                    // default MIDI-Out
  var piano_out_up = JZZ.input.Kbd({ at:'piano_out_up', chan:0,
  from: "C2",
  to: "C8",}).and(function(){
    this.getKeys().setStyle(null, { backgroundColor:'#0f0'});
  });;
  var piano_out_down = JZZ.input.Kbd({ at:'piano_out_down', chan:1,
  from: "C2",
  to: "C8",}).and(function(){
    this.getKeys().setStyle(null, { backgroundColor:'#00f'});
  });
                                                         // upper piano
  piano_out_up.connect(midi_out);                   // upper piano
  piano_out_down.connect(midi_out);

  --></script>

  <script type="text/javascript">
    var webSocket = $.simpleWebSocket({ url: 'ws://localhost:8080/midi' });

    var from_socket = JZZ.Widget();
    from_socket.connect(piano_out_up);
    from_socket.connect(piano_out_down);
    // reconnected listening
    webSocket.listen(function(message) {
        var lastTimestamp = message[0].Timestamp;
        for(let i = 0; i <message.length; i++) {
          var event = message[i];
          var diff = event.Timestamp - lastTimestamp;
          //if (event.Status === 145 || event.Status === 129) {
          //  event.Status = event.Status - 1
          //}
          var msg = JZZ.MIDI(event.Status, event.Data1, event.Data2);
          console.log(msg);
          if (diff > 0) {
            setTimeout(function() {
            from_socket.emit(msg);
            }, diff);
          } else {
            from_socket.emit(msg);
          }
          lastTimestamp = event.Timestamp;
        }
    });
  </script>
  </body>
  </html>
